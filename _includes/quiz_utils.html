<style>
  .quiz-container {
    max-width: 600px;
    margin: 20px auto;
    padding: 20px;
    font-family: Arial, sans-serif;
  }

  /* Progress Bar Styles */
  .progress-container {
    margin-bottom: 30px;
  }

  .progress-bar {
    width: 100%;
    height: 20px;
    background-color: #e0e0e0;
    border-radius: 10px;
    overflow: hidden;
    margin-bottom: 10px;
  }

  .progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #4CAF50, #45a049);
    border-radius: 10px;
    transition: width 0.3s ease;
    width: 0%;
  }

  .progress-text {
    text-align: center;
    font-weight: bold;
    color: #555;
    font-size: 14px;
  }

  /* Question Styles */
  .quiz-question {
    background-color: #f9f9f9;
    border: 1px solid #ddd;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 20px;
  }

  .quiz-question h3 {
    margin-top: 0;
    color: #333;
  }

  .quiz-question label {
    display: flex;
    align-items: center;
    margin: 0.2em 0;
    padding: 0.4em;
    border-radius: 5px;
    cursor: pointer;
    transition: background-color 0.2s ease;
  }

  .quiz-question label:hover {
    background-color: #f0f0f0;
  }

  .quiz-question label input[type="radio"] {
    margin-right: 8px;
  }

  .quiz-question.disabled label {
    pointer-events: none;
    opacity: 0.6;
  }

  .quiz-question.disabled input[type="radio"] {
    pointer-events: none;
  }

  /* Button Styles */
  button {
    background-color: #007bff;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 14px;
    margin-right: 10px;
    transition: background-color 0.2s ease;
  }

  button:hover {
    background-color: #0056b3;
  }

  .next-btn {
    background-color: #28a745;
  }

  .next-btn:hover {
    background-color: #1e7e34;
  }

  .retry-btn {
    background-color: #6c757d;
  }

  .retry-btn:hover {
    background-color: #545b62;
  }

  /* Results Styles */
  .quiz-results {
    background-color: #f8f9fa;
    border: 2px solid #007bff;
    border-radius: 10px;
    padding: 30px;
    text-align: center;
    max-width: 100%;
    word-wrap: break-word;
  }

  .quiz-results h3 {
    color: #007bff;
    margin-top: 0;
  }

  #finalScore {
    font-size: 16px;
    margin: 20px 0;
    padding: 20px;
    background-color: white;
    border-radius: 8px;
    border: 1px solid #ddd;
    text-align: left;
    line-height: 1.5;
    max-height: 400px;
    overflow-y: auto;
  }
</style>

<script>
// ============================================
// GOOGLE SPREADSHEET INFORMATION
// ============================================
const GOOGLE_SCRIPT_URL = "{{ site.data.secrets.google_script_url }}";

// ============================================
// QUIZ CONFIGURATION - ADD/REMOVE QUESTIONS HERE
// ============================================
const quizQuestions = [
  {
    question: "B·∫°n c√≥ ƒë·ªÉ √Ω c√°ch m√¨nh ng·ªìi trong ng√†y kh√¥ng?",
    options: [
      { text: "Kh√¥ng ƒë·ªÉ √Ω m·∫•y, ho·∫∑c ch∆∞a bi·∫øt n√≥ ·∫£nh h∆∞·ªüng ƒë·∫øn vi·ªác sinh", score: 1 },
      { text: "C≈©ng c√≥ l√∫c ƒë·ªÉ √Ω, l√∫c th√¨ qu√™n", score: 2 },
      { text: "C√≥, m√¨nh c·ªë g·∫Øng gi·ªØ t∆∞ th·∫ø t·ªët m·ªói ng√†y", score: 3 }
    ]
  },
  {
    question: "Khi ng·ªß, b·∫°n th∆∞·ªùng n·∫±m nghi√™ng b√™n n√†o?",
    options: [
      { text: "N·∫±m ng·ª≠a ho·∫∑c t∆∞ th·∫ø n√†o th·∫•y d·ªÖ ng·ªß l√† ƒë∆∞·ª£c", score: 1 },
      { text: "Th·ªânh tho·∫£ng nghi√™ng tr√°i", score: 2 },
      { text: "M√¨nh hay n·∫±m nghi√™ng tr√°i ƒë·ªÉ gi√∫p tu·∫ßn ho√†n t·ªët h∆°n", score: 3 }
    ]
  },
  {
    question: "B·∫°n ƒë√£ t·ª´ng th·ª≠ t·∫≠p squat ho·∫∑c t∆∞ th·∫ø ‚Äúc√°i b√†n‚Äù ch∆∞a?",
    options: [
      { text: "Ch∆∞a bi·∫øt ƒë√≥ l√† g√¨ ho·∫∑c c√≥ √≠ch g√¨", score: 1 },
      { text: "C√≥ nghe qua nh∆∞ng ch∆∞a t·∫≠p th∆∞·ªùng xuy√™n", score: 2 },
      { text: "C√≥, m√¨nh t·∫≠p 1‚Äì2 l·∫ßn m·ªói tu·∫ßn ho·∫∑c h∆°n", score: 3 }
    ]
  },
  {
    question: "M·ªói ng√†y b·∫°n c√≥ di chuy·ªÉn nh·∫π nh√†ng kh√¥ng?",
    options: [
      { text: "Ch·ªß y·∫øu ng·ªìi nhi·ªÅu, √≠t v·∫≠n ƒë·ªông", score: 1 },
      { text: "Th·ªânh tho·∫£ng ƒëi b·ªô ho·∫∑c v·∫≠n ƒë·ªông nh·∫π", score: 2 },
      { text: "M·ªói ng√†y m√¨nh ƒë·ªÅu c√≥ l√∫c ƒëi b·ªô ho·∫∑c t·∫≠p yoga nh·∫π", score: 3 }
    ]
  },
  {
    question: "Khi th·∫•y cƒÉng th·∫≥ng hay ƒëau nh·∫π, b·∫°n c√≥ bi·∫øt c√°ch ƒë·ªÉ c∆° th·ªÉ th·∫£ l·ªèng l·∫°i kh√¥ng?",
    options: [
      { text: "Kh√¥ng, m√¨nh th∆∞·ªùng c·ª©ng ƒë∆° c·∫£ ng∆∞·ªùi", score: 1 },
      { text: "C√≥ th·ªÉ th·∫£ l·ªèng m·ªôt ph·∫ßn nh∆∞ vai hay c·ªï", score: 2 },
      { text: "C√≥, m√¨nh t·∫≠p trung th·∫£ l·ªèng c·∫£ c∆° th·ªÉ, ƒë·∫∑c bi·ªát l√† b·ª•ng v√† m·∫∑t", score: 3 }
    ]
  },
  {
    question: "Khi lo l·∫Øng, b·∫°n c√≥ bi·∫øt c√°ch d√πng h∆°i th·ªü ƒë·ªÉ b√¨nh tƒ©nh l·∫°i kh√¥ng?",
    options: [
      { text: "Kh√¥ng bi·∫øt ho·∫∑c ch∆∞a t·ª´ng th·ª≠", score: 1 },
      { text: "C√≥ bi·∫øt nh∆∞ng ch∆∞a quen d√πng", score: 2 },
      { text: "C√≥, m√¨nh hay d√πng th·ªü ƒë·ªÉ xoa d·ªãu b·∫£n th√¢n", score: 3 }
    ]
  },
  {
    question: "B·∫°n c√≥ t·ª´ng h·ªçc k·ªπ thu·∫≠t th·ªü cho t·ª´ng giai ƒëo·∫°n chuy·ªÉn d·∫° ch∆∞a?",
    options: [
      { text: "Ch∆∞a nghe bao gi·ªù", score: 1 },
      { text: "C√≥ ƒë·ªçc ho·∫∑c xem qua nh∆∞ng ch∆∞a t·∫≠p", score: 2 },
      { text: "C√≥ h·ªçc v√† th·ª±c h√†nh ƒë·ªÅu", score: 3 }
    ]
  },
  {
    question: "B·∫°n hi·ªÉu t·ªõi ƒë√¢u v·ªÅ c√°c giai ƒëo·∫°n c·ªßa qu√° tr√¨nh sinh?",
    options: [
      { text: "Ch∆∞a t√¨m hi·ªÉu k·ªπ", score: 1 },
      { text: "Bi·∫øt s∆° s∆° nh∆∞ng ch∆∞a bi·∫øt ph·∫£i l√†m g√¨ t·ª´ng giai ƒëo·∫°n", score: 2 },
      { text: "M√¨nh hi·ªÉu r√µ v√† bi·∫øt m√¨nh s·∫Ω l√†m g√¨ trong t·ª´ng giai ƒëo·∫°n", score: 3 }
    ]
  },
  {
    question: "B·∫°n c√≥ t·ª´ng t·∫≠p c√°ch c·∫£m nh·∫≠n ho·∫∑c ƒëi·ªÅu khi·ªÉn c∆° s√†n ch·∫≠u kh√¥ng?",
    options: [
      { text: "Ch∆∞a bao gi·ªù nghe t·ªõi ho·∫∑c bi·∫øt l√†m sao t·∫≠p", score: 1 },
      { text: "C√≥ nghe n√≥i nh∆∞ng kh√¥ng ch·∫Øc m√¨nh l√†m ƒë√∫ng", score: 2 },
      { text: "C√≥, m√¨nh c·∫£m nh·∫≠n ƒë∆∞·ª£c r√µ r√†ng khi si·∫øt/th·∫£", score: 3 }
    ]
  },
  {
    question: "B·∫°n c√≥ hay b·ªã s√≥n ti·ªÉu khi ho, h·∫Øt h∆°i ho·∫∑c c∆∞·ªùi to kh√¥ng?",
    options: [
      { text: "C√≥, x·∫£y ra kh√° th∆∞·ªùng xuy√™n", score: 1 },
      { text: "Th·ªânh tho·∫£ng b·ªã", score: 2 },
      { text: "Kh√¥ng b·ªã", score: 3 }
    ]
  },
  {
    question: "B·∫°n ƒë√£ t·ª´ng t√¨m hi·ªÉu ho·∫∑c b·∫Øt ƒë·∫ßu t·∫≠p ph·ª•c h·ªìi s√†n ch·∫≠u ch∆∞a?",
    options: [
      { text: "Ch∆∞a t·ª´ng nghe ƒë·∫øn", score: 1 },
      { text: "C√≥ bi·∫øt nh∆∞ng ch∆∞a b·∫Øt ƒë·∫ßu", score: 2 },
      { text: "C√≥ r·ªìi, m√¨nh ƒëang t·∫≠p ho·∫∑c ƒë√£ l√™n k·∫ø ho·∫°ch", score: 3 }
    ]
  },
  {
    question: "B·∫°n c√≥ bi·∫øt t∆∞ th·∫ø n√†o gi√∫p em b√© ƒëi xu·ªëng d·ªÖ h∆°n kh√¥ng?",
    options: [
      { text: "Ch∆∞a t√¨m hi·ªÉu", score: 1 },
      { text: "C√≥ nghe n√≥i v√†i t∆∞ th·∫ø nh∆∞ng ch∆∞a quen t·∫≠p", score: 2 },
      { text: "Bi·∫øt r√µ v√† ƒëang √°p d·ª•ng nh∆∞ ƒë·ª©ng t·ª±a, nghi√™ng ng∆∞·ªùi, all fours...", score: 3 }
    ]
  },
  {
    question: "B·∫°n c√≥ t·ª´ng t·∫≠p th·∫£ l·ªèng v√πng √¢m ƒë·∫°o v√† t·∫ßng sinh m√¥n kh√¥ng?",
    options: [
      { text: "Ch∆∞a bi·∫øt c√≥ th·ªÉ t·∫≠p ƒëi·ªÅu n√†y", score: 1 },
      { text: "C√≥ nghe qua nh∆∞ng ch∆∞a th·ª±c h√†nh ƒë∆∞·ª£c", score: 2 },
      { text: "C√≥, m√¨nh ƒëang luy·ªán t·∫≠p v√† c·∫£m nh·∫≠n r√µ", score: 3 }
    ]
  },
  {
    question: "N·∫øu ca sinh di·ªÖn ra kh√¥ng nh∆∞ k·∫ø ho·∫°ch, b·∫°n s·∫Ω...",
    options: [
      { text: "R·∫•t lo l·∫Øng, d·ªÖ ho·∫£ng", score: 1 },
      { text: "Lo nh∆∞ng s·∫Ω c·ªë gi·ªØ b√¨nh tƒ©nh", score: 2 },
      { text: "M√¨nh ƒë√£ chu·∫©n b·ªã tinh th·∫ßn ƒë·ªÉ linh ho·∫°t v√† ·ª©ng bi·∫øn", score: 3 }
    ]
  },
  {
    question: "Khi nghƒ© ƒë·∫øn sinh con, b·∫°n c·∫£m th·∫•y...",
    options: [
      { text: "S·ª£ v√† kh√¥ng tin m√¨nh l√†m ƒë∆∞·ª£c", score: 1 },
      { text: "Lo nh∆∞ng v·∫´n c·ªë nghƒ© t√≠ch c·ª±c", score: 2 },
      { text: "C√≥ ni·ªÅm tin l√† m√¨nh s·∫Ω l√†m ƒë∆∞·ª£c", score: 3 }
    ]
  },
  {
    question: "B·∫°n ƒë√£ chu·∫©n b·ªã k·∫ø ho·∫°ch sinh (birth plan) v√† n√≥i chuy·ªán v·ªõi b√°c sƒ© ch∆∞a?",
    options: [
      { text: "Ch∆∞a t·ª´ng nghƒ© t·ªõi ho·∫∑c ch∆∞a t√¨m hi·ªÉu", score: 1 },
      { text: "C√≥ √Ω t∆∞·ªüng nh∆∞ng ch∆∞a n√≥i chuy·ªán v·ªõi ai", score: 2 },
      { text: "M√¨nh ƒë√£ vi·∫øt k·∫ø ho·∫°ch v√† th·∫£o lu·∫≠n v·ªõi b√°c sƒ©/n·ªØ h·ªô sinh", score: 3 }
    ]
  },
  {
    question: "B·∫°n ƒëang ·ªü tu·∫ßn thai th·ª© m·∫•y r·ªìi?",
    options: [
      { text: "D∆∞·ªõi 28 tu·∫ßn", score: 1 },
      { text: "28‚Äì36 tu·∫ßn", score: 2 },
      { text: "Tr√™n 36 tu·∫ßn", score: 3 }
    ]
  }
];

// ============================================
// QUIZ LOGIC - DON'T CHANGE BELOW THIS LINE
// ============================================
let currentQuestion = 0;
let totalQuestions = quizQuestions.length;
let totalScore = 0;
let answers = {};

function initializeQuiz() {
  currentQuestion = 0;
  totalScore = 0;
  answers = {};
  totalQuestions = quizQuestions.length;

  // Clear container
  document.getElementById('questionContainer').innerHTML = '';
  document.getElementById('results').style.display = 'none';

  // Generate all questions
  generateQuestions();

  // Show first question
  showQuestion(0);
  updateProgress();
}

function generateQuestions() {
  const container = document.getElementById('questionContainer');

  quizQuestions.forEach((q, index) => {
    const questionDiv = document.createElement('div');
    questionDiv.className = 'quiz-question';
    questionDiv.id = `question${index}`;
    questionDiv.style.display = 'none';

    let optionsHTML = '';
    q.options.forEach((option, optionIndex) => {
      optionsHTML += `
        <label>
          <input type="radio" name="q${index}" value="${optionIndex}" data-score="${option.score}"> ${option.text}
        </label>
      `;
    });

    questionDiv.innerHTML = `
      <h3>C√¢u ${index + 1}</h3>
      <p><strong>${q.question}</strong></p>
      <form>
        ${optionsHTML}
        <br>
        <button type="button" class="quiz-action-btn" onclick="handleQuizAction(this, ${index})">G·ª≠i C√¢u Tr·∫£ L·ªùi</button>
      </form>
      <p class="quiz-feedback" style="font-weight:bold;"></p>
    `;

    container.appendChild(questionDiv);
  });
}

function showQuestion(questionIndex) {
  // Hide all questions
  document.querySelectorAll('.quiz-question').forEach(q => {
    q.style.display = 'none';
  });

  // Show current question
  const currentQuestionDiv = document.getElementById(`question${questionIndex}`);
  if (currentQuestionDiv) {
    currentQuestionDiv.style.display = 'block';
  }
}

function updateProgress() {
  const progressFill = document.getElementById('progressFill');
  const progressText = document.getElementById('progressText');

  const progressPercentage = Math.round(((currentQuestion + 1) / totalQuestions) * 100);

  progressFill.style.width = progressPercentage + '%';
  progressText.textContent = `C√¢u ${currentQuestion + 1} / ${totalQuestions} (${progressPercentage}%)`;
}

function handleQuizAction(button, questionIndex) {
  const questionDiv = button.closest('.quiz-question');
  const feedback = questionDiv.querySelector('.quiz-feedback');
  const isLastQuestion = questionIndex === quizQuestions.length - 1;
  const nextButtonText = isLastQuestion ? 'Xem K·∫øt Qu·∫£' : 'C√¢u Ti·∫øp Theo';

  // Check if user has selected an answer
  const selectedInput = questionDiv.querySelector(`input[name="q${questionIndex}"]:checked`);
  if (!selectedInput) {
    feedback.textContent = 'Vui l√≤ng ch·ªçn m·ªôt c√¢u tr·∫£ l·ªùi tr∆∞·ªõc khi g·ª≠i.';
    feedback.style.color = '#721c24';
    feedback.style.display = 'block';
    return;
  }

  // Clear any error message
  feedback.style.display = 'none';

  // Lock in the answer (disable all inputs for this question)
  const allInputs = questionDiv.querySelectorAll(`input[name="q${questionIndex}"]`);
  allInputs.forEach(input => {
    input.disabled = true;
  })

  // Store the answer
  const userAnswerIndex = parseInt(selectedInput.value);
  const userScore = parseInt(selectedInput.dataset.score);

  answers[`q${questionIndex}`] = {
    selected: userAnswerIndex,
    score: userScore,
    question: quizQuestions[questionIndex].question,
    selectedText: quizQuestions[questionIndex].options[userAnswerIndex].text
  };
  totalScore += userScore;

  // Disable the current question (visual feedback that it's locked)
  questionDiv.classList.add('disabled');

  // Move to next question or show results
  if (isLastQuestion) {
    showResults();
  } else {
    currentQuestion++;
    showQuestion(currentQuestion);
    updateProgress();
  }
}

function showResults() {
  // Hide current question
  document.querySelectorAll('.quiz-question').forEach(q => {
    q.style.display = 'none';
  });

  // Update progress to 100%
  const progressFill = document.getElementById('progressFill');
  const progressText = document.getElementById('progressText');
  progressFill.style.width = '100%';
  progressText.textContent = 'Ho√†n Th√†nh! (100%)';

  // Show results with scoring message
  const resultsDiv = document.getElementById('results');
  const finalScore = document.getElementById('finalScore');

  // Calculate max possible score dynamically
  const maxPossibleScore = quizQuestions.reduce((total, question) => {
    const maxScoreForQuestion = Math.max(...question.options.map(option => option.score));
    return total + maxScoreForQuestion;
  }, 0);

  // Calculate score as percentage
  const scorePercentage = Math.round((totalScore / maxPossibleScore) * 100);

  // Determine message based on total score
  let scoreMessage = '';
  if (totalScore >= 44) {
    scoreMessage = `
      <strong>C∆† TH·ªÇ B·∫†N ƒê√É ${scorePercentage}% S·∫¥N S√ÄNG. B·∫†N C√ì TH·ªÇ BI·∫æT KH√Å R√ï T·ª™NG M·∫®U GH√âP</strong><br><br>
      N·∫øu b·∫°n mu·ªën c√≥ th√™m c√°i nh√¨n to√†n c·∫£nh v·ªÅ c∆° th·ªÉ, t√¢m tr√≠ c·ªßa b·∫°n cho vi·ªác sinh n·ªü, chia s·∫ª email ·ªü form d∆∞·ªõi ƒë√¢y.<br><br>
      M√¨nh s·∫Ω d√†nh 2-3 ng√†y t·ªõi ƒë·ªÉ ph√¢n t√≠ch c√¢u tr·∫£ l·ªùi c·ªßa b·∫°n v√† g·ª≠i h∆∞·ªõng ƒëi ti·∫øp theo ƒë·ªÉ b·∫°n c√≥ th·ªÉ s·∫µn s√†ng h∆°n n·ªØa. M·∫π b·∫ßu kh√¥ng c·∫ßn t·∫≠p nhi·ªÅu, ch·ªâ c·∫ßn t·∫≠p ƒë√∫ng v√† ƒë·ªß.<br><br>
    `;
  } else if (totalScore >= 34 && totalScore < 44) {
    scoreMessage = `
      <strong>C∆† TH·ªÇ B·∫†N ƒê√É ${scorePercentage}% S·∫¥N S√ÄNG, B·∫ÆT ƒê·∫¶U V√ÄO GU·ªíNG V√Ä C√ì N·ªÄN T·∫¢NG.</strong><br><br>
      Tuy nhi√™n c√≥ th·ªÉ b·∫°n ch∆∞a c√≥ c√°i nh√¨n t·ªïng qu√°t m√¨nh c·∫ßn g√¨ trong nh·ªØng tu·∫ßn t·ªõi ƒë·ªÉ t·∫≠p trung r√®n luy·ªán trong nh·ªØng tu·∫ßn c√≤n l·∫°i.<br><br>
      N·∫øu b·∫°n mu·ªën hi·ªÉu r√µ m√¨nh th·ª±c s·ª± ƒëang c·∫ßn g√¨, v√† nh·∫≠n b·∫£n ph√¢n t√≠ch chi ti·∫øt v·ªÅ ƒë·ªô s·∫µn s√†ng c·ªßa b·∫°n, chia s·∫ª email ·ªü form d∆∞·ªõi ƒë√¢y.<br><br>
      M√¨nh s·∫Ω d√†nh 2-3 ng√†y t·ªõi ƒë·ªÉ ph√¢n t√≠ch v√† g·ª≠i h∆∞·ªõng ƒëi ti·∫øp theo trong nh·ªØng tu·∫ßn mang thai c√≤n l·∫°i c·ªßa b·∫°n. M·∫π b·∫ßu kh√¥ng c·∫ßn t·∫≠p nhi·ªÅu, ch·ªâ c·∫ßn t·∫≠p ƒë√∫ng v√† ƒë·ªß.<br><br>
    `;
  } else if (totalScore < 34) {
    scoreMessage = `
      <strong>C∆† TH·ªÇ B·∫†N ƒê√É ${scorePercentage}% S·∫¥N S√ÄNG, V√Ä C√ì TH·ªÇ S·∫¥N S√ÄNG H∆†N.</strong><br><br>
      N·∫øu b·∫°n mu·ªën hi·ªÉu r√µ m√¨nh th·ª±c s·ª± ƒëang c·∫ßn g√¨, v√† nh·∫≠n b·∫£n ph√¢n t√≠ch chi ti·∫øt v·ªÅ ƒë·ªô s·∫µn s√†ng c·ªßa b·∫°n, chia s·∫ª email ·ªü form d∆∞·ªõi ƒë√¢y.<br><br>
      M√¨nh s·∫Ω d√†nh 2-3 ng√†y t·ªõi ƒë·ªÉ ph√¢n t√≠ch v√† g·ª≠i h∆∞·ªõng ƒëi ti·∫øp theo trong nh·ªØng tu·∫ßn mang thai c√≤n l·∫°i c·ªßa b·∫°n. M·∫π b·∫ßu kh√¥ng c·∫ßn t·∫≠p nhi·ªÅu, ch·ªâ c·∫ßn t·∫≠p ƒë√∫ng v√† ƒë·ªß.<br><br>
    `;
  }

  let endFinalMessage = `
    <strong>H√£y ƒë·∫£m b·∫£o email ƒë√∫ng ƒë·ªÉ nh·∫≠n ƒë∆∞·ª£c video üíå</strong><br><br>
    <input type="email" id="userEmail" placeholder="Nh·∫≠p email c·ªßa b·∫°n..." style="width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ccc; border-radius: 5px;">
    <div id="emailError" style="color: #721c24; font-size: 14px; margin: 5px 0; display: none;"></div>
    <button type="button" onclick="submitEmail()" style="width: 100%; padding: 12px; background-color: #28a745; color: white; border: none; border-radius: 5px; font-weight: bold;">G·ª≠i cho m√¨nh videos</button>
    <div id="emailSuccess" style="color: #155724; font-size: 14px; margin: 10px 0; display: none;">‚úÖ B·∫°n h√£y ƒë√≥n ch·ªù email t·ª´ m√¨nh nh√©!</div>
  `;

  finalScore.innerHTML = `
    <div>${scoreMessage}</div>
    <div>${endFinalMessage}</div>
  `;

  resultsDiv.style.display = 'block';
}

async function sendResultsToGoogleSheets() {
  const maxPossibleScore = quizQuestions.reduce((total, question) => {
    const maxScoreForQuestion = Math.max(...question.options.map(option => option.score));
    return total + maxScoreForQuestion;
  }, 0);

  const resultsData = {
    timestamp_au: (function() {
      const d = new Date();
      d.setHours(d.getHours() + 10);
      return d.toISOString().replace('Z', '+10:00');
    })(),
    totalQuestions: totalQuestions,
    totalScore: totalScore,
    maxPossibleScore: maxPossibleScore,
    scorePercentage: Math.round((totalScore / maxPossibleScore) * 100),
    email: answers.userEmail.email ? answers.userEmail.email : '',
  };

  // Dynamically add each answer's details
  for (let i = 0; i < quizQuestions.length; i++) {
    const ans = answers[`q${i}`] || {};
    resultsData[`question_${i+1}`] = ans.question || '';
    resultsData[`answer_${i+1}`] = ans.selectedText || '';
    resultsData[`score_${i+1}`] = ans.score !== undefined ? ans.score : '';
  }

  try {
    const response = await fetch(GOOGLE_SCRIPT_URL, {
      redirect: 'follow',
      method: 'POST',
      headers: {
        'Content-Type': 'text/plain;charset=utf-8',
      },
      body: JSON.stringify(resultsData)
    });

    if (response.ok) {
      const result = await response.json();
      console.log('Success:', result);

      const statusDiv = document.createElement('div');
      document.getElementById('results').appendChild(statusDiv);
    } else {
      throw new Error('Network response was not ok');
    }
  } catch (error) {
    console.error('Error:', error);
  }
}

function retryQuiz() {
  initializeQuiz();
}

// Email validation and submission function
function submitEmail() {
  const emailInput = document.getElementById('userEmail');
  const emailError = document.getElementById('emailError');
  const emailSuccess = document.getElementById('emailSuccess');
  const email = emailInput.value.trim();

  // Hide previous messages
  emailError.style.display = 'none';
  emailSuccess.style.display = 'none';

  // Simple email validation regex
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

  if (!email) {
    emailError.textContent = 'Vui l√≤ng nh·∫≠p email c·ªßa b·∫°n.';
    emailError.style.display = 'block';
    return;
  }

  if (!emailRegex.test(email)) {
    emailError.textContent = 'Vui l√≤ng nh·∫≠p m·ªôt ƒë·ªãa ch·ªâ email h·ª£p l·ªá.';
    emailError.style.display = 'block';
    return;
  }

  // Add email to answers object
  answers.userEmail = {
    email: email,
    submittedAt: (function() {
      const d = new Date();
      d.setHours(d.getHours() + 10);
      return d.toISOString().replace('Z', '+10:00');
    })()
  };

  // Show success message
  emailSuccess.style.display = 'block';

  // Disable the input and button
  emailInput.disabled = true;
  emailInput.style.backgroundColor = '#f8f9fa';
  const button = emailInput.nextElementSibling.nextElementSibling; // Get the button after error div
  button.disabled = true;
  button.textContent = 'ƒê√£ ghi nh·∫≠n email';
  button.style.backgroundColor = '#6c757d';

  console.log('Email recorded:', email);
  console.log('Updated answers:', answers);

  // Send results to Google Sheets
  sendResultsToGoogleSheets();
}

// Initialize quiz when page loads
window.addEventListener('load', initializeQuiz);
</script>
